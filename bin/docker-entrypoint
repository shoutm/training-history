#!/bin/bash -e

# If running the rails server then create or migrate existing database
if [ "${@: -2:1}" == "./bin/rails" ] && [ "${@: -1:1}" == "server" ]; then
  ./bin/rails db:prepare

  # Load Solid Cache/Queue/Cable schemas if their tables don't exist
  # All use the same DATABASE_URL, so we check before loading to avoid destroying data
  ./bin/rails runner "
    conn = ActiveRecord::Base.connection

    unless conn.table_exists?('solid_cache_entries')
      puts 'Creating Solid Cache tables...'
      ENV['DISABLE_DATABASE_ENVIRONMENT_CHECK'] = '1'
      Rake::Task['db:schema:load:cache'].invoke
    end

    unless conn.table_exists?('solid_queue_jobs')
      puts 'Creating Solid Queue tables...'
      ENV['DISABLE_DATABASE_ENVIRONMENT_CHECK'] = '1'
      Rake::Task['db:schema:load:queue'].invoke
    end

    unless conn.table_exists?('solid_cable_messages')
      puts 'Creating Solid Cable tables...'
      ENV['DISABLE_DATABASE_ENVIRONMENT_CHECK'] = '1'
      Rake::Task['db:schema:load:cable'].invoke
    end
  "
fi

exec "${@}"
